<!DOCTYPE html>
<html>
<head>
    <title>Spotify Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏, –∏–º–∏—Ç–∏—Ä—É—é—â–∏–µ Spotify */
        body { 
            font-family: 'Circular Std', Arial, sans-serif;
            text-align: center; 
            background-color: #121212; 
            color: white; 
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            padding: 20px;
        }
        /* --- –û–±—â–∏–µ —Å–ø–∏—Å–∫–∏ (–ü–ª–µ–π–ª–∏—Å—Ç—ã –∏ –õ–∞–π–∫–∏) --- */
        #playlists-section, #liked-tracks-section {
            text-align: left;
            margin-bottom: 20px;
            background-color: #191919;
            padding: 15px;
            border-radius: 10px;
        }
        #playlists-section h3, #liked-tracks-section h3 {
            margin-top: 0;
            color: #1DB954;
        }
        #playlists-list button {
            background: none;
            border: none;
            color: white;
            text-align: left;
            width: 100%;
            padding: 10px 0;
            border-bottom: 1px solid #282828;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 1em;
        }
        #playlists-list button:hover {
            background-color: #282828;
        }
        /* --- –°–µ–∫—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ (–ü–ª–µ–µ—Ä) --- */
        #current-track {
            margin-bottom: 30px;
            background-color: #282828;
            padding: 20px 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        #album-art {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }
        #like-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #b3b3b3;
            transition: color 0.1s;
        }
        #like-btn.liked {
            color: #1DB954; /* –ó–µ–ª–µ–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ, –∫–æ–≥–¥–∞ –ª–∞–π–∫–Ω—É—Ç */
        }
        /* --- –¢—Ä–µ–∫–∏ "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è" (–ö–æ–ª–ª–µ–∫—Ü–∏—è) --- */
        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #282828;
        }
        .track-item span {
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }
        .track-item button {
             background-color: #1DB954;
             border: none;
             color: white;
             padding: 5px 10px;
             border-radius: 50%;
             font-size: 0.8em;
             cursor: pointer;
        }
        /* --- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä, –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ü–æ–∏—Å–∫ --- */
        .controls button {
            background: none;
            border: none;
            color: white;
            padding: 15px;
            font-size: 24px;
            cursor: pointer;
        }
        .controls #playPauseBtn {
            font-size: 40px;
            margin: 0 20px;
        }
        .progress-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: #b3b3b3;
            font-size: 0.8em;
        }
        #progress-bar {
            flex-grow: 1;
            height: 4px;
            background: #535353;
            border-radius: 2px;
            margin: 0 10px;
            position: relative;
        }
        #progress-bar-fill {
            height: 100%;
            width: 0%;
            background: #1DB954;
            border-radius: 2px;
        }
        /* –ü–æ–∏—Å–∫ */
        #search-section {
            background-color: #191919;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap; 
        }
        #search-query {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 5px 0 0 5px;
            background-color: #404040;
            color: white;
        }
        #searchBtn {
            padding: 10px;
            border: none;
            border-radius: 0 5px 5px 0;
            background-color: #1DB954;
            color: white;
            font-weight: bold;
        }
        #search-result {
            width: 100%;
            margin-top: 10px;
            color: #b3b3b3;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">

        <div id="playlists-section">
            <h3>–í–∞—à–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã</h3>
            <div id="playlists-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div id="search-section">
            <input type="text" id="search-query" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞...">
            <button id="searchBtn">–ù–∞–π—Ç–∏ –∏ Play</button>
            <div id="search-result"></div>
        </div>

        <div id="current-track">
            <img id="album-art" src="" alt="Album Art">
            <button id="like-btn" class="unliked" title="–î–æ–±–∞–≤–∏—Ç—å –≤ '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è'" style="display:none;">ü§ç</button>
            <div id="track-info">
                <h2 id="track-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="artist-name">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
            </div>
        </div>

        <div class="progress-bar-container">
            <span id="progress-time">0:00</span>
            <div id="progress-bar"><div id="progress-bar-fill"></div></div>
            <span id="duration-time">0:00</span>
        </div>

        <div class="controls">
            <button id="prevBtn">‚èÆÔ∏è</button>
            <button id="playPauseBtn">‚ñ∂Ô∏è</button>
            <button id="nextBtn">‚è≠Ô∏è</button>
        </div>
        
        <div id="liked-tracks-section">
            <h3>–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è (–∫–æ–ª–ª–µ–∫—Ü–∏—è)</h3>
            <div id="liked-tracks-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <p style="margin-top: 30px; font-size: 0.8em; color: #535353;">
            ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="tg_user_id">...</span>
        </p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        let user_id = null;
        let currentTrackId = null;
        let isPlaying = false;
        let currentProgressInterval = null;

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ User ID / –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            user_id = tg.initDataUnsafe.user.id.toString();
            document.getElementById('tg_user_id').textContent = user_id;
            checkTokenAndRedirect(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–ª–µ–µ—Ä–∞
        } else {
             tg.showAlert('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞.');
        }

        // --- API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ ---
        function checkTokenAndRedirect() {
             fetch('/api/check_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.is_authorized) {
                    // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∫–æ—Ä–Ω–µ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç)
                    window.location.href = '/'; 
                } else {
                    // –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
                    loadLists();
                    updatePlayerStatus();
                    setInterval(updatePlayerStatus, 5000); 
                }
            })
            .catch(() => tg.showAlert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞.'));
        }

        // --- 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï (Play/Next/Prev) ---
        function sendControlCommand(action) {
            if (!user_id) return;

            const actionRoute = (action === 'playpause') ? 'playpause' : (action === 'next' ? 'next' : 'prev');

            fetch(`/api/control/${actionRoute}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setTimeout(updatePlayerStatus, 500); 
                } else {
                    tg.showAlert(`–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${data.message}`);
                }
            })
            .catch(() => tg.showAlert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥—ã.'));
        }
        
        // --- 3. –£–ü–†–ê–í–õ–ï–ù–ò–ï –õ–ê–ô–ö–û–ú (–°–ï–†–î–ï–ß–ö–û) ---
        document.getElementById('like-btn').onclick = function() {
            if (!user_id || !currentTrackId) {
                tg.showAlert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞ –¥–ª—è –ª–∞–π–∫–∞.');
                return;
            }
            
            const isLiked = this.classList.contains('liked');

            fetch(`/api/like_toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id, track_id: currentTrackId, is_liked: isLiked })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('liked');
                    this.textContent = isLiked ? 'ü§ç' : 'üíö';
                    tg.showPopup({message: data.message});
                    loadLists(); 
                } else {
                    tg.showAlert(`–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞: ${data.message}`);
                }
            })
            .catch(() => tg.showAlert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ.'));
        };

        // --- 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ü–õ–ï–ï–†–ê ---
        function updatePlayerStatus() {
            if (!user_id) return;

            fetch(`/api/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id })
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(currentProgressInterval);
                document.getElementById('like-btn').style.display = 'none';

                if (!data.success) {
                    document.getElementById('track-name').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.';
                    document.getElementById('artist-name').textContent = data.message;
                    document.getElementById('album-art').src = '';
                    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
                    currentTrackId = null;
                    return;
                }

                if (!data.track_name) {
                    document.getElementById('track-name').textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ —Ç—Ä–µ–∫–∞.';
                    document.getElementById('artist-name').textContent = data.message;
                    document.getElementById('album-art').src = '';
                    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
                    currentTrackId = null;
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—Ä–µ–∫–µ
                currentTrackId = data.track_id;
                document.getElementById('track-name').textContent = data.track_name;
                document.getElementById('artist-name').textContent = data.artist_name;
                document.getElementById('album-art').src = data.image_url || '';
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –õ–∞–π–∫
                document.getElementById('like-btn').style.display = 'block';
                if (data.is_liked) {
                    document.getElementById('like-btn').classList.add('liked');
                    document.getElementById('like-btn').textContent = 'üíö';
                } else {
                    document.getElementById('like-btn').classList.remove('liked');
                    document.getElementById('like-btn').textContent = 'ü§ç';
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Play/Pause
                isPlaying = data.is_playing;
                document.getElementById('playPauseBtn').textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                const duration = data.duration_ms;
                const progress = data.progress_ms;

                document.getElementById('duration-time').textContent = formatTime(duration);
                document.getElementById('progress-time').textContent = formatTime(progress);
                
                const percentage = (progress / duration) * 100;
                document.getElementById('progress-bar-fill').style.width = `${percentage}%`;

                if (isPlaying) {
                     let currentMs = progress;
                     currentProgressInterval = setInterval(() => {
                        currentMs += 1000;
                        document.getElementById('progress-time').textContent = formatTime(currentMs);
                        const currentPercentage = (currentMs / duration) * 100;
                        document.getElementById('progress-bar-fill').style.width = `${currentPercentage}%`;
                        if (currentMs >= duration) {
                            clearInterval(currentProgressInterval);
                            setTimeout(updatePlayerStatus, 500); 
                        }
                    }, 1000);
                }
            })
            .catch(() => {
                 document.getElementById('track-name').textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.';
                 clearInterval(currentProgressInterval);
            });
        }
        
        // --- 5. –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –ü–õ–ï–ô–õ–ò–°–¢–û–í –ò –ö–û–õ–õ–ï–ö–¶–ò–ò ---
        function loadLists() {
            if (!user_id) return;
            
            fetch(`/api/playlists`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    const errorMsg = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–æ–≤: ${data.message}`;
                    document.getElementById('playlists-list').textContent = errorMsg;
                    document.getElementById('liked-tracks-list').textContent = errorMsg;
                    return;
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
                const plList = document.getElementById('playlists-list');
                plList.innerHTML = '';
                data.playlists.forEach(pl => {
                    const button = document.createElement('button');
                    button.textContent = pl.name;
                    button.onclick = () => searchAndPlay(pl.uri, true);
                    plList.appendChild(button);
                });

                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è"
                const ltList = document.getElementById('liked-tracks-list');
                ltList.innerHTML = '';
                data.liked_tracks.forEach(track => {
                    const div = document.createElement('div');
                    div.className = 'track-item';
                    const span = document.createElement('span');
                    span.textContent = `${track.name} - ${track.artist}`;
                    const button = document.createElement('button');
                    button.textContent = '‚ñ∂Ô∏è';
                    button.onclick = () => searchAndPlay(track.uri, true); 
                    
                    div.appendChild(span);
                    div.appendChild(button);
                    ltList.appendChild(div);
                });

            })
            .catch(() => {
                const errorMsg = `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–æ–≤.`;
                document.getElementById('playlists-list').textContent = errorMsg;
                document.getElementById('liked-tracks-list').textContent = errorMsg;
            });
        }
        
        // --- 6. –ü–û–ò–°–ö –ò –ó–ê–ü–£–°–ö ---
        function searchAndPlay(queryOrUri, isUri = false) {
            if (!user_id) {
                tg.showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.');
                return;
            }
            let query = queryOrUri;
            
            if (!isUri) {
                query = document.getElementById('search-query').value.trim();
                if (!query) return;
            }

            document.getElementById('search-result').textContent = isUri ? "–ó–∞–ø—É—Å–∫..." : `–ò—â—É —Ç—Ä–µ–∫: "${query}"...`;

            fetch(`/api/search_play`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id, query: query, is_uri: isUri })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('search-result').textContent = data.message;
                if (data.success) {
                    document.getElementById('search-query').value = '';
                    setTimeout(updatePlayerStatus, 1000);
                }
            })
            .catch(() => {
                document.getElementById('search-result').textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏ –∑–∞–ø—É—Å–∫–µ.';
            });
        }

        // --- 7. –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –ò –ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ò–Ø ---
        document.getElementById('playPauseBtn').onclick = () => sendControlCommand('playpause');
        document.getElementById('nextBtn').onclick = () => sendControlCommand('next');
        document.getElementById('prevBtn').onclick = () => sendControlCommand('prev');
        document.getElementById('searchBtn').onclick = () => searchAndPlay(null, false);

        tg.MainButton.setText("–ó–∞–∫—Ä—ã—Ç—å Mini App").onClick(() => tg.close()).show();
    </script>
</body>
</html>
